<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <ui:composition>
        <h:form prependId="false"  onsubmit="return false;" onkeydown="return disableEnter();">
            <p:panelGrid id="packagePanel" styleClass="transparent" style="margin: auto;">
                <p:row>
                    <p:column>
                        <p:outputLabel for="amount" value="小包数量："/>
                    </p:column>
                    <p:column>
                        <p:spinner id="amount" value="#{packScanner.amount}"
                                   size="3" min="20" max="200" stepFactor="10">
                            <p:ajax process="@this" update="amount"/>
                        </p:spinner>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column>
                        <p:outputLabel for="packCodeInputForPackage" value="条码输入："/>
                    </p:column>
                    <p:column>
                        <p:inputText id="packCodeInputForPackage" onkeyup="return codeInputKeyup('packCodeInputForPackage','packCodeInputForPackageAddButton');"
                                     value="#{packScanner.packCode}"/>
                        <p:focus for="packCodeInputForPackage"/>
                    </p:column>
                    <p:column>
                        <script type="text/javascript">
                            function addPackCode() {
                                var packCode = $('#packCodeInputForPackage').val();
                                if (packCode.indexOf('1000') === 0) {
                                    $('#bulkPackCode').val(packCode);
                                } else {
                                    $('#smallPackCodes').append('<li>' + packCode + '</li>');
                                    var smallPackCodesCsv = $('#smallPackCodesCsv').val();
                                    alert('before: ' + smallPackCodesCsv);
                                    if (!smallPackCodesCsv) {
                                        smallPackCodesCsv = packCode;
                                    } else {
                                        smallPackCodesCsv = smallPackCodesCsv + ',' + packCode;
                                    }
                                    alert('after: ' + smallPackCodesCsv);
                                    $('#smallPackCodesCsv').val(smallPackCodesCsv);
                                }
                            }
                        </script>
                        <p:commandButton type="button" value="添加" onclick="addPackCode();"/>
                    </p:column>
                </p:row>
                
                <p:row>
                    <p:column>
                        <p:outputLabel for="selectSeedId" value="种子批次："/>
                    </p:column>
                    <p:column>
                        <p:selectOneMenu id="selectSeedId" value="#{packScanner.seedId}" 
                                             style="font-size: 90%;">
                            <f:selectItems value="#{seedManager.seeds}"
                                           var="seed" itemLabel="#{seed.seedUiDisplay}" itemValue="#{seed.id}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                
                <p:row>
                    <p:column>
                        <p:outputLabel for="bulkPackCode" value="大包条码："/>
                    </p:column>
                    <p:column>
                        <p:inputText id="bulkPackCode" readonly="true"
                                     value="#{packScanner.bulkPackCode}"/>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column>
                        <h:outputText value="小包条码："/>
                    </p:column>
                    <p:column colspan="2">
                        <h:inputHidden id="smallPackCodesCsv" value="#{packScanner.smallPackCodesCsv}"/>
                        <p:scrollPanel mode="native" style="height: 200px;">
                            <ol id="smallPackCodes"/>
                        </p:scrollPanel>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column colspan="3">
                        <h:panelGroup layout="block" styleClass="submit">
                            <p:commandButton id="bindPackageCodes" value="绑定" action="#{packScanner.bindCodes}"
                                             process="amount selectSeedId bulkPackCode smallPackCodesCsv @this"
                                             update="packCodeInputForPackage bulkPackCode"
                                             oncomplete="PrimeFaces.focus('packCodeInputForPackage'); $('#smallPackCodes').html('');"/>
                        </h:panelGroup>
                    </p:column>
                </p:row>
            </p:panelGrid>
            
            <p:blockUI block="packagePanel" trigger="bindPackageCodes" > 数据保存中...</p:blockUI>
        </h:form>
    </ui:composition>
</html>
